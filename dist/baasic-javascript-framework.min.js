/*
 Baasic SDK JavaScript v0.9.0
 (c) 2014-2016 Mono http://baasic.com
 License: MIT
*/
!function(e,t,n,i){function a(e,t){for(var n in t)e[n]=t[n];return e}var r=e.MonoSoftware||(e.MonoSoftware={}),o=n!==i?function(e,t,i){n(t).on(e,i)}:function(e,t,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent?t.attachEvent("on"+e,n):t["on"+e]=n},u=n!==i?function(e,t,i){var r=a(n.Event(t),i);n(e).trigger(r)}:function(e,n,i){var r;return CustomEvent&&"function"==typeof CustomEvent?(r=a(new CustomEvent(n)),void e.dispatchEvent(r)):t.createEvent?(r=t.createEvent("CustomEvent"),r.initEvent(n,!0,!0),i&&a(r,i),void(e.dispatchEvent?e.dispatchEvent(r):t.dispatchEvent(r))):(r=t.createEventObject(),r.eventType=n,i&&a(r,i),void e.fireEvent("on"+r.eventType,r))};!function(n){!function(n){function r(e){localStorage.removeItem(f),localStorage.setItem(f,JSON.stringify(e))}function s(e,t){return new g(e,t)}function c(e){u(t,"tokenExpired",{app:e}),r({type:d.tokenExpired})}function p(e){u(t,"tokenUpdated",{app:e}),r({type:d.tokenUpdated})}function g(n,s){function g(e){if(e&&e.expireTime){var t=e.expireTime-(new Date).getTime();if(t>0)return setTimeout(function(){E.storeToken(null),c(T)},t);E.storeToken(null)}return null}function v(e){if(clearTimeout(w),e!==i&&null!==e){if(!e.expireTime){var t=e.expires_in,n=e.sliding_window;t?e.expireTime=(new Date).getTime()+1e3*t:n&&(e.expireTime=(new Date).getTime()+1e3*n)}w=g(e)}}var m="baasic-user-info-"+n,k="baasic-auth-token-"+n,E={useSSL:!1,defaultLanguage:"en",apiRootUrl:"api.baasic.com",apiVersion:"v1",storeToken:function(e){e===i||null===e?localStorage.removeItem(k):localStorage.setItem(k,JSON.stringify(e))},readToken:function(){return JSON.parse(localStorage.getItem(k))},storeUserInfo:function(e){e===i||null===e?localStorage.removeItem(m):localStorage.setItem(m,JSON.stringify(e))},readUserInfo:function(){return JSON.parse(localStorage.getItem(m))}},T=this;a(E,s);var h=(E.useSSL?"https":"http")+"://"+E.apiRootUrl+"/"+E.apiVersion+"/"+n+"/",S=E.readToken(),w=null,U={isAuthenticated:function(){var e=T.getAccessToken();return e!==i&&null!==e&&(e.expireTime===i||null===e.expireTime||e.expireTime-(new Date).getTime()>0)}};S&&(w=g(S)),o("storage",e,function(e){if(e=e||event,e.originalEvent&&(e=e.originalEvent),e.key===f){var n=e.newValue;if(n&&""!==n){var i=JSON.parse(n);switch(i.type){case d.userChanged:u(t,"userChange",{user:T.getUser(),app:T});break;case d.tokenExpired:v(null),u(t,"tokenExpired",{app:T});break;case d.tokenUpdated:u(t,"tokenUpdated",{app:T})}}}}),this.getApiKey=function(){return n},this.getApiUrl=function(){return h},this.getAccessToken=function(){return E.readToken()},this.updateAccessToken=function(e){v(e),E.storeToken(e),e===i||null===e?c(T):p(T)},this.getUser=function(){var e=E.readUserInfo();return e?U.user=e:delete U.user,U},this.setUser=function(e){E.storeUserInfo(e),r({type:d.userChanged})},this.getDefaultLanguage=function(){return E.defaultLanguage},this.getCurrentLanguage=function(){return E.language?E.language:l?l:T.getDefaultLanguage()}}var l=navigator.language||navigator.userLanguage,f="baasic-message-bus",d={tokenExpired:"tokenExpired",tokenUpdated:"tokenUpdated",userChanged:"userChanged"};n.init=s}(n.Application||(n.Application={}))}(r.Baasic||(r.Baasic={}))}(window,document,window.jQuery);